!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("leaflet"),require("geoportal-access-lib"),require("@mapbox/corslite"),require("promise-queue")):"function"==typeof define&&define.amd?define(["leaflet","geoportal-access-lib","@mapbox/corslite","promise-queue"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).leaflet_trackstats=e(t.L,t.Gp,t.corslite,t.Queue)}(this,(function(t,e,n,r){"use strict";function i(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var o=i(t),a=i(e),s=i(n),u=i(r),c={},l=8;function h(t,e){return function(t,e,n){return"".concat(Math.roundE(e,n),"/").concat(Math.roundE(t,n))}(t.lat,t.lng,e)}void 0===Math.roundE&&(Math.roundE=function(t,e){var n=Math.pow(10,e);return Math.round(t*n)/n});var f={setPrecision:function(t){return l=t,this},add:function(t,e){var n=h(e,l);return n in c||(c[n]={}),c[n][t]=e[t],this},get:function(t,e){var n=h(e,l);return n in c&&t in c[n]?c[n][t]:void 0},has:function(t,e){var n=h(e,l);return n in c&&(null===t||t in c[n])},hasZ:function(t){return this.has("z",t)},hasSlope:function(t){return this.has("slope",t)},addZ:function(t){return this.add("z",t),this},addSlope:function(t){return this.add("slope",t),this},getAll:function(t){var e=h(t,l),n=e in c?c[e]:{};return{lat:t.lat,lng:t.lng,z:"z"in n?n.z:void 0,slope:"slope"in n?n.slope:void 0}},clear:function(){return Object.keys(c).forEach((function(t){return delete c[t]})),this}},p=o.default.Class.extend({options:{},initialize:function(t,e){if(o.default.Util.setOptions(this,e),this.startingDistance=0,this.distance=0,this.altMin=Number.MAX_VALUE,this.altMax=Number.MIN_VALUE,this.heightDiffUp=0,this.heightDiffDown=0,this.slopeMin=Number.MAX_VALUE,this.slopeMax=Number.MIN_VALUE,this.slopeTerrainMin=Number.MAX_VALUE,this.slopeTerrainMax=Number.MIN_VALUE,this.latlngs=[],0!==t.length){var n=JSON.parse(JSON.stringify(t));this.altMin=n[0].z,this.altMax=n[0].z,this.slopeTerrainMin=n[0].slope,this.slopeTerrainMax=n[0].slope,n[0].dist=0,n[0].slopeOnTrack=0,this.latlngs.push(n[0]);for(var r=0,i=1;i<n.length;i+=1){var a=o.default.latLng(n[i]).distanceTo(o.default.latLng(this.latlngs[r]));if(a>0){this.distance+=a/1e3,r+=1,this.latlngs[r]=n[i];var s=this.latlngs[r];if(s.dist=this.distance,s.z){s.z<this.altMin&&(this.altMin=s.z),s.z>this.altMax&&(this.altMax=s.z);var u=s.z-this.latlngs[r-1].z;u<0?this.heightDiffDown+=Math.round(-u):u>0&&(this.heightDiffUp+=Math.round(u)),s.slopeOnTrack=Math.round(Math.degrees(Math.atan(u/a)))}else s.slopeOnTrack=0;s.slope&&(s.slope<this.slopeTerrainMin&&(this.slopeTerrainMin=s.slope),s.slope>this.slopeTerrainMax&&(this.slopeTerrainMax=s.slope))}}for(var c=this.latlngs.length,l=0;l<c;l+=1)l>3&&l<c-4&&(this.latlngs[l].slopeOnTrack=(this.latlngs[l-3].slopeOnTrack+2*this.latlngs[l-2].slopeOnTrack+4*this.latlngs[l-1].slopeOnTrack+8*this.latlngs[l].slopeOnTrack+4*this.latlngs[l+1].slopeOnTrack+2*this.latlngs[l+2].slopeOnTrack+this.latlngs[l+3].slopeOnTrack)/22,this.latlngs[l].slopeOnTrack<this.slopeMin&&(this.slopeMin=this.latlngs[l].slopeOnTrack),this.latlngs[l].slopeOnTrack>this.slopeMax&&(this.slopeMax=this.latlngs[l].slopeOnTrack));void 0===this.altMin&&(this.heightDiffUp=void 0,this.heightDiffDown=void 0,this.slopeMax=void 0,this.slopeMin=void 0)}},accumulate:function(t){return t.latlngs=t.latlngs.concat(this.getLatLngs().map((function(e){return e.dist+=t.distance,e}))),t.distance+=this.distance,t.altMin=Math.min(this.altMin,t.altMin),t.altMax=Math.max(this.altMax,t.altMax),t.heightDiffUp+=this.heightDiffUp,t.heightDiffDown+=this.heightDiffDown,t.slopeMin=Math.min(this.slopeMin,t.slopeMin),t.slopeMax=Math.max(this.slopeMax,t.slopeMax),t.slopeTerrainMin=Math.min(this.slopeTerrainMin,t.slopeTerrainMin),t.slopeTerrainMax=Math.max(this.slopeTerrainMax,t.slopeTerrainMax),this},getLatLngs:function(){return JSON.parse(JSON.stringify(this.latlngs))},getDistance:function(){return this.distance},getAltMin:function(){return this.altMin},getAltMax:function(){return this.altMax},getSlopeMin:function(){return this.slopeMin},getSlopeMax:function(){return this.slopeMax},getHeightDiffUp:function(){return this.heightDiffUp},getHeightDiffDown:function(){return this.heightDiffDown},getSlopeTerrainMin:function(){return this.slopeTerrainMin},getSlopeTerrainMax:function(){return this.slopeTerrainMax}});function d(t){var e=t.getLatLngs();if(e.length>0&&Array.isArray(e[0])){for(var n=[],r=0;r<e.length;r+=1)n=n.concat(e[r]);return n}return e}void 0===Math.degrees&&(Math.degrees=function(t){return 180*t/Math.PI}),o.default.Polyline.include({_stats:void 0,getStats:function(){return this._stats},fetchAltitude:function(t,e){if(!("altitudes"in t.features)||!t.features.altitudes)return new Promise((function(t,e){return e(new Error("Unsupported"))}));f.setPrecision(t.precision);var n=Array.from(new Set(d(this))).filter((function(t){return!f.hasZ(t)}));return 0===n.length?new Promise((function(t){return t()})):(e&&e.fire("TrackStats:fetching",{datatype:"altitudes",size:n.length}),new Promise((function(r,i){t.fetchAltitudes(n,e).then((function(t){t.forEach((function(t){return f.addZ(t)})),e&&e.fire("TrackStats:done",{datatype:"altitudes",size:t.length}),r()})).catch((function(t){return i(t)}))})))},fetchSlope:function(t,e){if(!("slopes"in t.features)||!t.features.slopes)return new Promise((function(t,e){return e(new Error("Unsupported"))}));f.setPrecision(t.precision);var n=Array.from(new Set(d(this))).filter((function(t){return!f.hasSlope(t)}));return 0===n.length?new Promise((function(t){return t()})):(e&&e.fire("TrackStats:fetching",{datatype:"slopes",size:n.length}),new Promise((function(r,i){t.fetchSlopes(n,e).then((function(t){t.forEach((function(t){return f.addSlope(t)})),e&&e.fire("TrackStats:done",{datatype:"slopes",size:t.length}),r()})).catch((function(t){return i(t)}))})))},fetchInfos:function(t,e){var n=[];return"altitudes"in t.features&&t.features.altitudes&&n.push(this.fetchAltitude(t,e)),"slopes"in t.features&&t.features.slopes&&n.push(this.fetchSlope(t,e)),Promise.all(n)},computeStats:function(){var t=d(this).map((function(t){return t.getCachedInfos()}));return this._stats=new p(t),this.getStats()}}),o.default.LatLng.prototype.getCachedInfos=function(){return f.getAll(this)},void 0!==o.default.TrackDrawer&&(o.default.TrackDrawer.Track.include({_steps:void 0,_total:void 0,_i:0,_bindEvent:function(){var t=this;this.on("TrackDrawer:start",(function(){t._i+=1})),this.on("TrackDrawer:failed",(function(e){t._i-=1,t._fireEvents&&t.fire("TrackDrawer:statsfailed",{message:e.message})})),this.on("TrackDrawer:done",(function(){t._finalizeRoute(t.options.fetcher).catch((function(e){t._i-=1,t._fireEvents&&t.fire("TrackDrawer:statsfailed",{message:e.message})}))}))},_finalizeRoute:function(t){var e=this,n=[],r=this._getNode(this._firstNodeId);return this._nodesContainers.forEach((function(){do{var t=e._getNext(r),i=t.nextEdge,o=t.nextNode;if(void 0===r||void 0===i)break;n.push(i),r=o}while("stopover"!==r.options.type)})),new Promise((function(r,i){var o=[];n.forEach((function(n){o.push(n.fetchInfos(t,e).then((function(){return n.computeStats()})))})),Promise.all(o).then((function(){e._i-=1,0===e._i&&e._computeStats(),r()})).catch((function(t){return i(t)}))}))},getStatsTotal:function(){return this._total},getStatsSteps:function(){return this._steps},_computeStats:function(){var t=this;this._steps=[],this._total=new p([]);var e=new p([]),n=this._getNode(this._firstNodeId);return void 0!==n&&this._nodesContainers.forEach((function(r,i){n._stats={startingDistance:e.getDistance(),distance:t._total.getDistance(),z:n.getLatLng().getCachedInfos().z},(e=new p([])).startingDistance=t._total.getDistance();do{var o=t._getNext(n),a=o.nextEdge,s=o.nextNode;if(void 0===n||void 0===a)break;var u=a.getStats();void 0!==u&&u.accumulate(t._total).accumulate(e),(n=s)._stats={startingDistance:e.getDistance(),distance:t._total.getDistance(),z:n.getLatLng().getCachedInfos().z}}while("stopover"!==n.options.type);t._edgesContainers.get(i)._stats=e,t._steps.push(e)})),this._fireEvents&&this.fire("TrackDrawer:statsdone",{}),this}}),o.default.TrackDrawer.Track.addInitHook("_bindEvent"));var g=function(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r};var v=function(t){if(Array.isArray(t))return g(t)};var y=function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)};var m=function(t,e){if(t){if("string"==typeof t)return g(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?g(t,e):void 0}};var w=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var x=function(t){return v(t)||y(t)||m(t)||w()};var _=o.default.Class.extend({options:{queueConcurrency:5},initialize:function(t,e,n){this._apiKey=t,this._map=e,this.features={altitudes:!0,slopes:!0},this.precision=8,o.default.Util.setOptions(this,n),this._queue=new u.default(this.options.queueConcurrency,1/0)},fetchAltitudes:function(t,e){var n=this,r=[],i=[];if(t.forEach((function(t){if(r.push({lon:t.lng,lat:t.lat}),50===r.length){var o=r.splice(0);i.push(n._queue.add((function(){return n._fetchBatchAltitude(o,e)})))}})),r.length>0){var o=r.splice(0);i.push(this._queue.add((function(){return n._fetchBatchAltitude(o,e)})))}return new Promise((function(t,e){Promise.all(i).then((function(e){var n=[];e.forEach((function(t){return n.push.apply(n,x(t))})),t(n)})).catch((function(t){return e(t)}))}))},_doFetchBatchAltitude:function(t,e,n,r,i){var o=this;a.default.Services.getAltitude({apiKey:this._apiKey,sampling:t.length,positions:t,onSuccess:function(t){var r=[];t.elevations.forEach((function(t){r.push({lat:t.lat,lng:t.lon,z:t.z})})),e&&e.fire("TrackStats:fetched",{datatype:"altitudes",size:r.length}),n(r)},onFailure:function(a){i?o._doFetchBatchAltitude(t,e,n,r,!1):r(new Error(a.message))}})},_fetchBatchAltitude:function(t,e){var n=this;return new Promise((function(r,i){n._doFetchBatchAltitude(t,e,r,i,!0)}))},fetchSlopes:function(t,e){var n=this,r={},i=[],a=this._map?this._map.options.crs:this.options.crs||o.default.CRS.EPSG3857,s=this._map?this._map.getPixelOrigin():this.options.pixelOrigin;return t.forEach((function(t){var e=function(t,e,n,r,i){var o=e.latLngToPoint(t,n).floor(),a=o.divideBy(r).floor(),s=a.multiplyBy(r).subtract(i);return{tile:a,tilePixel:o.subtract(i).subtract(s)}}(t,a,16,256,s),n=e.tile,i=e.tilePixel;n.x in r||(r[n.x]={}),n.y in r[n.x]||(r[n.x][n.y]=[[]]);var o=r[n.x][n.y];o[o.length-1].length>50&&o.push([]),o[o.length-1].push({lat:t.lat,lng:t.lng,x:i.x,y:i.y})})),Object.keys(r).forEach((function(t){Object.keys(r[t]).forEach((function(o){r[t][o].forEach((function(r){i.push(n._queue.add((function(){return n._fetchBatchSlope(t,o,r,e)})))}))}))})),new Promise((function(t,e){Promise.all(i).then((function(e){var n=[];e.forEach((function(t){return n.push.apply(n,x(t))})),t(n)})).catch((function(t){return e(t)}))}))},_fetchBatchSlope:function(t,e,n,r){var i=e,o=t,a="",u="",c="",l="",h=this._apiKey;n.forEach((function(t,e){e>0&&(a+="|",u+="|",c+="|",l+="|"),a+=t.lng.toString(),u+=t.lat.toString(),c+=t.x.toString(),l+=t.y.toString()}));var f="slope.php?tilematrix=".concat(16,"&tilerow=").concat(i,"&tilecol=").concat(o)+"&lon=".concat(a,"&lat=").concat(u,"&x=").concat(c,"&y=").concat(l,"&apikey=").concat(h);return new Promise((function(t,e){s.default(f,(function(n,i){if(n)try{var o=JSON.parse(n.responseText);e(new Error(o.error))}catch(t){e(t)}else try{var a=JSON.parse(i.responseText);if(a.results){var s=[];a.results.forEach((function(t){s.push({lat:t.lat,lng:t.lon,slope:t.slope})})),r&&r.fire("TrackStats:fetched",{datatype:"slopes",size:s.length}),t(s)}else e(new Error("Impossible d'obtenir les données de pentes: résultats invalides"))}catch(t){e(t)}}),!1)}))}});var M=function(t,e,n){return t(n={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&n.path)}},n.exports),n.exports}((function(t){var e=function(t){var e,n=Object.prototype,r=n.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function u(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,n){return t[e]=n}}function c(t,e,n,r){var i=e&&e.prototype instanceof v?e:v,o=Object.create(i.prototype),a=new O(r||[]);return o._invoke=function(t,e,n){var r=h;return function(i,o){if(r===p)throw new Error("Generator is already running");if(r===d){if("throw"===i)throw o;return A()}for(n.method=i,n.arg=o;;){var a=n.delegate;if(a){var s=S(a,n);if(s){if(s===g)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(r===h)throw r=d,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r=p;var u=l(t,e,n);if("normal"===u.type){if(r=n.done?d:f,u.arg===g)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r=d,n.method="throw",n.arg=u.arg)}}}(t,n,a),o}function l(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}t.wrap=c;var h="suspendedStart",f="suspendedYield",p="executing",d="completed",g={};function v(){}function y(){}function m(){}var w={};w[o]=function(){return this};var x=Object.getPrototypeOf,_=x&&x(x(L([])));_&&_!==n&&r.call(_,o)&&(w=_);var M=m.prototype=v.prototype=Object.create(w);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function T(t,e){function n(i,o,a,s){var u=l(t[i],t,o);if("throw"!==u.type){var c=u.arg,h=c.value;return h&&"object"==typeof h&&r.call(h,"__await")?e.resolve(h.__await).then((function(t){n("next",t,a,s)}),(function(t){n("throw",t,a,s)})):e.resolve(h).then((function(t){c.value=t,a(c)}),(function(t){return n("throw",t,a,s)}))}s(u.arg)}var i;this._invoke=function(t,r){function o(){return new e((function(e,i){n(t,r,e,i)}))}return i=i?i.then(o,o):o()}}function S(t,n){var r=t.iterator[n.method];if(r===e){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=e,S(t,n),"throw"===n.method))return g;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return g}var i=l(r,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var o=i.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function b(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function k(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function O(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(b,this),this.reset(!0)}function L(t){if(t){var n=t[o];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,a=function n(){for(;++i<t.length;)if(r.call(t,i))return n.value=t[i],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}return{next:A}}function A(){return{value:e,done:!0}}return y.prototype=M.constructor=m,m.constructor=y,y.displayName=u(m,s,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===y||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,m):(t.__proto__=m,u(t,s,"GeneratorFunction")),t.prototype=Object.create(M),t},t.awrap=function(t){return{__await:t}},E(T.prototype),T.prototype[a]=function(){return this},t.AsyncIterator=T,t.async=function(e,n,r,i,o){void 0===o&&(o=Promise);var a=new T(c(e,n,r,i),o);return t.isGeneratorFunction(n)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(M),u(M,s,"Generator"),M[o]=function(){return this},M.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var n in t)e.push(n);return e.reverse(),function n(){for(;e.length;){var r=e.pop();if(r in t)return n.value=r,n.done=!1,n}return n.done=!0,n}},t.values=L,O.prototype={constructor:O,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(k),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function i(r,i){return s.type="throw",s.arg=t,n.next=r,i&&(n.method="next",n.arg=e),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var u=r.call(a,"catchLoc"),c=r.call(a,"finallyLoc");if(u&&c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,g):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),g},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),k(n),g}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;k(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:L(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}(t.exports);try{regeneratorRuntime=e}catch(t){Function("r","regeneratorRuntime = r")(e)}})),E=M;function T(t,e,n,r,i,o,a){try{var s=t[o](a),u=s.value}catch(t){return void n(t)}s.done?e(u):Promise.resolve(u).then(r,i)}var S=function(t){return function(){var e=this,n=arguments;return new Promise((function(r,i){var o=t.apply(e,n);function a(t){T(o,r,i,a,s,"next",t)}function s(t){T(o,r,i,a,s,"throw",t)}a(void 0)}))}},b=o.default.Class.extend({options:{server:"https://api.open-elevation.com/api",queueConcurrency:1},initialize:function(t,e){this._map=t,this.features={altitudes:!0,slopes:!1},this.precision=6,o.default.Util.setOptions(this,e),this._queue=new u.default(this.options.queueConcurrency,1/0)},fetchAltitudes:function(t,e){var n=this,r=[],i=[];if(t.forEach((function(t){if(r.push({lon:t.lng,lat:t.lat}),1e3===r.length){var o=r.splice(0);i.push(n._queue.add((function(){return n._fetchBatchAltitude(o,e)})))}})),r.length>0){var o=r.splice(0);i.push(this._queue.add((function(){return n._fetchBatchAltitude(o,e)})))}return new Promise((function(t,e){Promise.all(i).then((function(e){var n=[];e.forEach((function(t){return n.push.apply(n,x(t))})),t(n)})).catch((function(t){return e(t)}))}))},_fetchBatchAltitude:function(t,e){var n=t.map((function(t){return{latitude:t.lat,longitude:t.lon}})),r="".concat(this.options.server,"/v1/lookup");return window.fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({locations:n})}).then(function(){var t=S(E.mark((function t(n){var r,i,o,a,s,u;return E.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if((r=n.headers.get("content-type"))&&-1!==r.indexOf("application/json")){t.next=3;break}throw new Error("Error: invalid response");case 3:return t.next=5,n.json();case 5:if(i=t.sent,o=[],s=!1,i.results.forEach((function(t){0===t.elevation&&(t.elevation=a,void 0===a&&(s=!0)),o.push({lat:t.latitude,lng:t.longitude,z:t.elevation}),a=t.elevation})),s)for(u=o.length-1;u>=0;u-=1)void 0===o[u].z&&(o[u].z=a),a=o[u].z;return e&&e.fire("TrackStats:fetched",{datatype:"altitudes",size:o.length}),t.abrupt("return",o);case 12:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())},fetchSlopes:function(){return Promise.reject(new Error("Unsupported"))}}),k=o.default.Class.extend({options:{dataset:"aster30m",queueConcurrency:5},initialize:function(t,e,n){this.server=t,this._map=e,this.features={altitudes:!0,slopes:!1},this.precision=6,o.default.Util.setOptions(this,n),this._queue=new u.default(this.options.queueConcurrency,1/0)},fetchAltitudes:function(t,e){var n=this,r=[],i=[];if(t.forEach((function(t){if(r.push({lon:t.lng,lat:t.lat}),100===r.length){var o=r.splice(0);i.push(n._queue.add((function(){return n._fetchBatchAltitude(o,e)})))}})),r.length>0){var o=r.splice(0);i.push(this._queue.add((function(){return n._fetchBatchAltitude(o,e)})))}return new Promise((function(t,e){Promise.all(i).then((function(e){var n=[];e.forEach((function(t){return n.push.apply(n,x(t))})),t(n)})).catch((function(t){return e(t)}))}))},_fetchBatchAltitude:function(t,e){var n=t.map((function(t){return"".concat(t.lat,",").concat(t.lon)})).join("|"),r="".concat(this.server,"/v1/").concat(this.options.dataset,"?locations=").concat(n);return window.fetch(r).then(function(){var t=S(E.mark((function t(n){var r,i,o,a,s,u;return E.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if((r=n.headers.get("content-type"))&&-1!==r.indexOf("application/json")){t.next=3;break}throw new Error("Error: invalid response");case 3:return t.next=5,n.json();case 5:if("OK"===(i=t.sent).status){t.next=8;break}throw new Error("Status is ".concat(i.status));case 8:if(o=[],s=!1,i.results.forEach((function(t){null===t.elevation&&(t.elevation=a,void 0===a&&(s=!0)),o.push({lat:t.location.lat,lng:t.location.lng,z:t.elevation}),a=t.elevation})),s)for(u=o.length-1;u>=0;u-=1)void 0===o[u].z&&(o[u].z=a),a=o[u].z;return e&&e.fire("TrackStats:fetched",{datatype:"altitudes",size:o.length}),t.abrupt("return",o);case 14:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())},fetchSlopes:function(){return Promise.reject(new Error("Unsupported"))}});return o.default.TrackStats={cache:f,Geoportail:_,OpenElevation:b,OpenTopoData:k,Stats:p,geoportail:function(t,e,n){return new _(t,e,n)},openElevation:function(t,e){return new b(t,e)},openTopoData:function(t,e,n){return new k(t,e,n)}},o.default.TrackStats}));
//# sourceMappingURL=leaflet.trackstats.umd.min.js.map
